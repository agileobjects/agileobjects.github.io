(function(n){(function(t){(function(i){i.emailRegex=/[^@\s]+@[^@\s]+\.[^@\s]+$/;var r=function(){function n(){var n=this;this.possibles=[];this.currentIndex=0;this.image=t.getById("avatar-preview");this.imageDefault=this.image.src;this.image.onerror=function(){n.tryLoad(!0)}}return n.prototype.load=function(n){this.possibles=this.buildPossibles(n.value);this.currentIndex=0;this.tryLoad()},n.prototype.buildPossibles=function(n){var t=[];return n.match(i.emailRegex)?t.push("https://secure.gravatar.com/avatar/"+md5(n)+"?s=80&d=identicon&r=pg"):(t.push("https://github.com/"+n+".png"),t.push("https://avatars.io/twitter/"+n+"/medium")),t},n.prototype.tryLoad=function(n){if(n&&++this.currentIndex,this.currentIndex<this.possibles.length){this.image.src=this.possibles[this.currentIndex];return}this.image.onerror=null;this.image.src=this.imageDefault},n}(),u=function(){function u(){this.avatar=new r;this.comment=t.getById("comment");this.name=t.getById("name");this.identity=t.getById("identity");this.email=t.getById("email");this.rememberMe=t.getById("remember")}return u.prototype.load=function(){var n=this;this.identity.onchange=function(){n.avatar.load(this)};this.retrieveUser();this.identity.value&&this.avatar.load(this.identity)},u.prototype.retrieveUser=function(){var n=!1;window.localStorage.name&&(this.name.value=window.localStorage.name,n=!0);window.localStorage.identity&&(this.identity.value=window.localStorage.identity,n=!0);n&&(this.rememberMe.checked=!0)},u.prototype.storeUser=function(n,t){window.localStorage.name=n;window.localStorage.identity=t},u.prototype.handlePost=function(r){var e=n(r),u,f;return e.valid()?(u=t.getById("comment-submit"),u.value!=="Confirm comment")?(u.value="Confirm comment",u.title="Click again to confirm your comment",u.classList.add("confirm-button"),!1):(this.rememberMe.checked?this.storeUser(this.name.value,this.identity.value):this.storeUser("",""),f={postId:t.getById("post-id").value,commentSite:t.getById("comment-site").value,message:this.comment.value,name:this.name.value,avatar:this.avatar.image.src},this.identity.value.match(i.emailRegex)&&(f.email=this.identity.value),n.ajax({type:"post",url:r.action,data:f,xhrFields:{withCredentials:!1}}).fail(function(){t.formError()}).done(function(){t.formOk()}),!1):!1},u.prototype.handlePosted=function(n){n||t.formReset(t.$getById("comment-form"))},u.prototype._getName=function(){return t.getById("name")},u.prototype._getIdentity=function(){return t.getById("identity")},u.prototype._getRememberMe=function(){return t.getById("remember")},u}();n(function(){i.commentForm=new u;i.commentForm.load()})})(t.Web||(t.Web={}))})(window.AgileObjects||(window.AgileObjects={}))})(jQuery);